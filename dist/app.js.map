{"version":3,"sources":["../routes/index.js","../routes/api.js","app.js"],"names":["express","require","fs","router","Router","get","req","res","next","render","post","send","line","body","time","writeFileSync","i","hrrr","basin","grb","grib2","appendFileSync","length","latt","lon","module","exports","fetch","util","readFile","promisify","bodyParser","process","env","DRIVE_TEXAS_API","then","response","json","feature","type","features","properties","condition","query","push","coordinates","visible","polygons","avoid_polygons","options","get_polygon","layer","data","JSON","parse","geometries","stringify","headers","method","directions","fileName","config","createError","path","logger","sassMiddleware","compression","indexRouter","apiRouter","app","set","join","__dirname","use","urlencoded","extended","src","dest","indentedSyntax","sourceMap","outputStyle","prefix","static","err","locals","message","error","status"],"mappings":"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","file":"app.js","sourceRoot":"../src","sourcesContent":["var express = require('express');\nconst fs = require(\"fs\");\nvar router = express.Router();\n\n/* GET home page. */\nrouter.get('/', function(req, res, next) {\n    res.render('home');\n});\n\n// Receives POSTed HRRR data and rewrites HTML table and CSV file.\nrouter.post('/get_hrrr', function (req, res) {\n    res.send({\"msg\": \"Thank you!\"});\n    // Write necessary HTML to create a table.\n    let line = \"<html><head><title>VCORE | HRRR</title><link rel=\\\"stylesheet\\\" href=\\\"https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css\\\" integrity=\\\"sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm\\\" crossorigin=\\\"anonymous\\\"></head>\";\n    line += \"<body><img width='400px' src='https://vcore.utrgv.edu/images/cameron-subbasin.png'><img width='500px' src='https://vcore.utrgv.edu/images/willacy-subbasin.png'><table class='table'><tr><th>Basin</th><th colspan='36'>HRRR data for the next 36 hours starting from \" + req.body.time + \":00</th></tr>\";\n    fs.writeFileSync(\"/srv/www/public/HRRR/grib2.html\", line); // Clear and write into HTML file.\n    fs.writeFileSync(\"/srv/www/public/HRRR/grib2.csv\", \"Latitude1, Longitude1, Latitude2, Longitude2, Basin, HRRR Data from \" + req.body.time + \":00\\n\"); // Clear and write into CSV file.\n    var i = 0;\n    for (let hrrr of req.body.hrrr) {\n        // Append necessary HTML tags.\n        line = '<tr><td>' + hrrr.basin + '</td>';\n        for (let grb of hrrr.grib2) {\n            line += '<td>' + grb + '</td>';\n        }\n        fs.appendFileSync(\"/srv/www/public/HRRR/grib2.html\", line);\n        // If it's the last line, close necessary HTML tags.\n        if (i >= req.body.hrrr.length - 1) {\n            line = \"</table></body></html>\";\n            fs.appendFileSync(\"/srv/www/public/HRRR/grib2.html\", line);\n        }\n        i++;\n        fs.appendFileSync(\"/srv/www/public/HRRR/grib2.csv\", hrrr.latt[0] + \",\" + hrrr.lon[0] + \",\" + hrrr.latt[1] + \",\" + hrrr.lon[1] + \",\" + hrrr.basin + \",\" + hrrr.grib2 + \"\\n\");\n    }\n});\n\nmodule.exports = router;\n","const express = require('express');\nconst router = express.Router();\nconst fetch = require('node-fetch')\nconst fs = require('fs');\nconst util = require('util');\nconst readFile = util.promisify(fs.readFile);\n\nconst bodyParser = require('body-parser');\n\n// Create cache for this function since conditions update every 5 minutes.\nrouter.get('/dtx', function(req, res, next) {\n  fetch(`https://api.drivetexas.org/api/conditions.geojson?key=${process.env.DRIVE_TEXAS_API}`)\n    .then( response => response.json())\n    .then(function (response) {\n      let feature = { type: \"FeatureCollection\", features: [] };\n      for (let i=0; i<response.features.length; i++) {\n        if (response.features[i].properties.condition === req.query.feature) {\n          feature.features.push(response.features[i]);\n        }\n      }\n      res.json(feature);\n    });\n});\n\n\n// Send coordinates to ORS API and shape file if selected.\nrouter.post('/ors', async function(req, res, next){\n    let body = {\n        coordinates: req.body.coordinates,\n    };\n\n    if (req.body.visible) {\n        let polygons = { avoid_polygons: {} };\n        body.options = await get_polygon(req.body.layer + '.geojson').then(data => {\n            polygons.avoid_polygons = JSON.parse(data).geometries[0];\n            return polygons;\n        });\n    }\n\n    fetch(\"http://129.113.4.41:8080/ors/v2/directions/driving-car/geojson\", {\n        body: JSON.stringify(body),\n        headers: {\n        \"Content-Type\": \"application/json\"\n        },\n        method: \"POST\"\n        }).then(response => response.json())\n            .then(function (directions){\n            res.send(directions);\n        });\n});\n\nfunction get_polygon(fileName) {\n  return readFile('/srv/www/public/geojson/' + fileName);\n}\n\nmodule.exports = router;\n","require('dotenv').config();\n\nconst createError = require('http-errors');\nconst express = require('express');\nconst path = require('path');\nconst logger = require('morgan');\nconst sassMiddleware = require('node-sass-middleware');\nconst compression = require('compression');\n\nconst indexRouter = require('../routes/index');\nconst apiRouter = require('../routes/api');\n\nconst app = express();\n\n// view engine setup\napp.set('views', path.join(__dirname, '../views'));\napp.set('view engine', 'pug');\n\napp.use(logger('dev'));\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\napp.use(sassMiddleware({\n  src: path.join(__dirname, '../src/sass'),\n  dest: path.join(__dirname, '../public/stylesheets'),\n  indentedSyntax: true, // true = .sass and false = .scss\n  sourceMap: false,\n  outputStyle: 'compressed',\n  prefix: '/stylesheets'\n}));\napp.use(express.static(path.join(__dirname, '../public')));\napp.use(compression());\n\napp.use('/', indexRouter);\napp.use('/api', apiRouter);\n\n// External things\napp.use('/mod/bs', express.static(path.join(__dirname, '../node_modules/bootstrap/dist')));\napp.use('/mod/jq', express.static(path.join(__dirname, '../node_modules/jquery/dist')));\napp.use('/mod/ol', express.static(path.join(__dirname, '../node_modules/ol')));\napp.use('/mod/fa', express.static(path.join(__dirname, '../node_modules/font-awesome/css')));\napp.use('/mod/ol-ls', express.static(path.join(__dirname, '../node_modules/ol-layerswitcher/src')));\napp.use('/mod/ol-cm', express.static(path.join(__dirname, '../node_modules/ol-contextmenu/dist')));\napp.use('/mod/ol-pu', express.static(path.join(__dirname, '../node_modules/ol-popup/src')));\n\n// catch 404 and forward to error handler\napp.use(function (req, res, next) {\n  next(createError(404));\n});\n\n// error handler\napp.use(function (err, req, res, next) {\n  // set locals, only providing error in development\n  res.locals.message = err.message;\n  res.locals.error = req.app.get('env') === 'development' ? err : {};\n\n  // render the error page\n  res.status(err.status || 500);\n  res.render('error');\n});\n\nmodule.exports = app;\n"]}